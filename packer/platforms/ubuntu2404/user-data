#cloud-config
autoinstall:
  version: 1
  # early-commands:
  #   # Stop ssh for packer
  #   - sudo systemctl stop ssh
  locale: en_US.UTF-8
  keyboard:
    layout: us
  source:
    id: ubuntu-server
  storage:
    config:
      # physical disk
      - type: disk
        id: pv.0
        match:
          size: largest
        ptable: gpt
      # /boot/efi
      - type: partition
        id: part-bootefi
        device: pv.0
        size: 1G
        flag: boot
      - type: format
        id: format-bootefi
        volume: part-bootefi
        fstype: vfat
      - type: mount
        id: mount-efi
        device: format-bootefi
        path: /boot/efi
      # /boot
      - type: partition
        id: part-boot
        device: pv.0
        size: 1G
      - type: format
        id: format-boot
        volume: part-boot
        fstype: xfs
      - type: mount
        id: mount-boot
        device: format-boot
        path: /boot
      # LVM physical volumes
      - type: partition
        id: lvm-part
        device: pv.0
        size: 100%
        flag: lvm
      # LVM volume groups
      - type: lvm_volgroup
        id: vg-systemvg
        name: systemvg
        devices: [lvm-part]
      # /
      - type: lvm_logical_volume
        id: lv-sysroot
        name: sysroot
        volgroup: vg-systemvg
        size: 10G
      - type: format
        id: format-sysroot
        volume: lv-sysroot
        fstype: xfs
      - type: mount
        id: mount-sysroot
        device: format-sysroot
        path: /
      # /home
      - type: lvm_logical_volume
        id: lv-home
        name: home
        volgroup: vg-systemvg
        size: 4G
      - type: format
        id: format-home
        volume: lv-home
        fstype: xfs
      - type: mount
        id: mount-home
        device: format-home
        path: /home
      # /opt
      - type: lvm_logical_volume
        id: lv-opt
        name: opt
        volgroup: vg-systemvg
        size: 4G
      - type: format
        id: format-opt
        volume: lv-opt
        fstype: xfs
      - type: mount
        id: mount-opt
        device: format-opt
        path: /opt
      # /var
      - type: lvm_logical_volume
        id: lv-var
        name: var
        volgroup: vg-systemvg
        size: 10G
      - type: format
        id: format-var
        volume: lv-var
        fstype: xfs
      - type: mount
        id: mount-var
        device: format-var
        path: /var
      # /var/log
      - type: lvm_logical_volume
        id: lv-varlog
        name: varlog
        volgroup: vg-systemvg
        size: 5G
      - type: format
        id: format-varlog
        volume: lv-varlog
        fstype: xfs
      - type: mount
        id: mount-varlog
        device: format-varlog
        path: /var/log
      # /var/log/audit
      - type: lvm_logical_volume
        id: lv-varlogaudit
        name: varlogaudit
        volgroup: vg-systemvg
        size: 4G
      - type: format
        id: format-varlogaudit
        volume: lv-varlogaudit
        fstype: xfs
      - type: mount
        id: mount-varlogaudit
        device: format-varlogaudit
        path: /var/log/audit
      # /var/tmp
      - type: lvm_logical_volume
        id: lv-vartmp
        name: vartmp
        volgroup: vg-systemvg
        size: 4G
      - type: format
        id: format-vartmp
        volume: lv-vartmp
        fstype: xfs
      - type: mount
        id: mount-vartmp
        device: format-vartmp
        path: /var/tmp
  ssh:
    install-server: true
    allow-pw: true
  debconf-selections: |
    openssh-server openssh-server/permit-root-login boolean true
    ufw ufw/enable boolean false
  packages:
    - cifs-utils
    - cloud-init
    - libnfs-utils
  user-data:
    chpasswd:
      expire: false
    disable_root: false
    users:
      - name: root
        passwd: "$2b$10$x6oAEJWARGocQHSyRjBPeea3F5EHBxazKejSU2ZixWJyJnwKM3uIq"
        lock_passwd: false
        shell: /bin/bash
